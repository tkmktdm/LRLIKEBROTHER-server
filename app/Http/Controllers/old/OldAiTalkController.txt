<?php

namespace App\Http\Controllers;

use App\Models\AiTalk;
use App\Models\AiTalkHistory;
use App\Models\Category;
use App\Services\AiTalkHistoryService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Http;

use Gemini\Data\Content;
use Gemini\Enums\Role;
use Gemini\Laravel\Facades\Gemini;
use Illuminate\Support\Facades\Date;
use Illuminate\Support\Facades\Storage;


class AiTalkController extends Controller
{

  // Gemini
  public function geminiGenerateTalk(Request $request, AiTalkHistoryService $service)
  {
    // $talkHistory = AiTalkHistory::all();
    $userId = auth()->id();
    $taskId = 6;
    // $taskId = $request["task_id"];
    $talkHistorys = $service->get($userId, $taskId);
    // AIä½¿ç”¨åˆ¶é™ã‚’ç¢ºèª
    if ($talkHistorys[0]["geminiIsActive"] === 0) {
      return ["status" => 401, "message" =>  "èªè¨¼ã‚¨ãƒ©ãƒ¼"];
    }
    // return $talkHistory;
    $talks = [];
    // ä¼šè©±ãƒ‡ãƒ¼ã‚¿
    // foreach ($talkHistorys as $talkHistory) {
    //     $role = $service->formatSpeaker($talkHistory["select_speaker"], "gemini");
    //     array_push($talk, ["role" => $role, "part" => $talkHistory["message"]]);
    // }
    // template
    $conversationSummary = $talkHistorys || "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç›®æ¨™ã‚’æœ€åˆã«è³ªå•ã—ã¦ãã ã•ã„ã€‚";
    $lastMessage = data_get($talkHistorys, (count($talkHistorys) - 1) . '.message', '');
    $today = now();

    array_unshift(
      $talks,
      // [
      //   "role" => "user",
      //   "message" => "ã‚ãªãŸã¯æ˜ã‚‹ãã¦å„ªã—ã„å‹‰å¼·ã‚µãƒãƒ¼ãƒˆã‚­ãƒ£ãƒ©ã€è‘µã€ã§ã™ã€‚é€šå¸¸ã®ä¼šè©±ã¯50æ–‡å­—ç¨‹åº¦ã§ä¼šè©±ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚"
      // ],
      [
        "role" => "system",
        "message" => <<<PROMPT
ã‚ãªãŸã¯æ˜ã‚‹ãå„ªã—ã„ã‚µãƒãƒ¼ãƒˆã‚­ãƒ£ãƒ©ã€Œè‘µã€ã§ã™ã€‚
é€šå¸¸ä¼šè©±ã¯å¿…ãš 50ã€œ100æ–‡å­—ä»¥å†…ã§è¿”ã—ã¦ãã ã•ã„ã€‚

PROMPT
      ],
      [
        "role" => "system",
        "message" => <<<PROMPT
ã‚ãªãŸã¯ã‚¿ã‚¹ã‚¯ç”Ÿæˆã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚

ã“ã‚Œã‹ã‚‰ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ä¼šè©±ã‚’è¡Œã£ãŸä¸Šã§ã€
ä¼šè©±å†…å®¹ã«å¯¾ã™ã‚‹è‡ªç„¶ãªè¿”ç­”ã¨ã€
ã‚«ãƒ†ã‚´ãƒªãƒ¼ + ã‚¿ã‚¹ã‚¯ä¸€è¦§ã®JSONã‚’åŒæ™‚ã«å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸‹ã®å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’çµ¶å¯¾ã«å®ˆã£ã¦ãã ã•ã„ï¼š

<CONVERSATION>
ã“ã“ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®ä¼šè©±ã«å¯¾ã™ã‚‹è‡ªç„¶ãªè¿”ç­”ã‚’æ›¸ãã€‚
Markdownè£…é£¾ã‚„ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆ```ï¼‰ã¯ä½¿ã‚ãªã„ã“ã¨ã€‚
</CONVERSATION>

<JSON_OUTPUT>
ã“ã“ã«ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¨ã‚¿ã‚¹ã‚¯ã®JSONãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã™ã‚‹ã€‚

ä»¥ä¸‹ã®JSONå½¢å¼ã‚’å³å®ˆã™ã‚‹ã“ã¨ï¼š
{"category": {"name": "string","description": "string"},"tasks": [{"name": "string","description": "string","start_date": "YYYY-MM-DD HH:MM:SS","end_date": "YYYY-MM-DD HH:MM:SS","difficulty": "easy | medium | hard"}]}

JSONã®å‰å¾Œã«ä½™è¨ˆãªæ–‡ç« ã€ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã€è¨˜å·ã€æ”¹è¡Œã¯å…¥ã‚Œãªã„ã“ã¨ã€‚
</JSON_OUTPUT>

é‡è¦äº‹é …ï¼š
- <CONVERSATION> ã¨ </CONVERSATION> ã®ã‚¿ã‚°ã¯çµ¶å¯¾ã«æ¶ˆã•ãªã„ãƒ»å£Šã•ãªã„ã“ã¨ã€‚
- <JSON_OUTPUT> ã¨ </JSON_OUTPUT> ã®ã‚¿ã‚°ã¯çµ¶å¯¾ã«æ¶ˆã•ãªã„ãƒ»å£Šã•ãªã„ã“ã¨ã€‚
- JSON ã¯å¿…ãšæœ‰åŠ¹ãªæ§‹æ–‡ã«ã™ã‚‹ã“ã¨ã€‚
- JSONã¯å¿…ãš1ã¤ã ã‘å‡ºåŠ›ã™ã‚‹ã“ã¨ã€‚
- JSONéƒ¨åˆ†ã«ã¯Markdownè£…é£¾ã‚’å…¥ã‚Œãªã„ã“ã¨ã€‚
- æ–‡ç« éƒ¨åˆ†ã§ã¯è‡ªç”±ã«è¿”ä¿¡ã—ã¦ã‚ˆã„ãŒã€ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã¯ç¦æ­¢ã€‚

â— ãƒ«ãƒ¼ãƒ«
- ã‚¿ã‚¹ã‚¯ã¯3ã€œ7ä»¶ã€‚
- start_date/end_date ã¯å¿…ãš {$today}ã€œ{$today->addWeekday()} ã®ç¯„å›²ã€‚
- æ—¥ä»˜ãŒã‚ã‚‹å ´åˆã€ä»Šæ—¥ã‹ã‚‰2é€±é–“ä»¥å†…ã«ã™ã‚‹ã€‚
- é€šå¸¸ä¼šè©±ãªã—ã§ JSON ã ã‘è¿”ã™ã®ã¯ç¦æ­¢ã€‚
- JSON ã¯æœ‰åŠ¹ãªæ§‹é€ ã§è¿”ã™ã€‚
PROMPT
      ],


      //       [
      //         "role" => "system",
      //         "message" => <<<PROMPT
      // ã‚ãªãŸã¯æ˜ã‚‹ãå„ªã—ã„ã‚µãƒãƒ¼ãƒˆã‚­ãƒ£ãƒ©ã€Œè‘µã€ã§ã™ã€‚
      // é€šå¸¸ä¼šè©±ã¯å¿…ãš 50ã€œ100æ–‡å­—ä»¥å†…ã§è¿”ã—ã¦ãã ã•ã„ã€‚

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®ä¼šè©±ã«è‡ªç„¶ã«ç­”ãˆãŸå¾Œã€
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¿ã‚¹ã‚¯ä½œæˆã‚’æ±‚ã‚ãŸå ´åˆã€ã¾ãŸã¯ç›®çš„ãŒæ˜ç¢ºã«ãªã£ãŸå ´åˆã®ã¿
      // ã€Œã‚¿ã‚¹ã‚¯ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰ã€ã‚’ç™ºå‹•ã—ã¦ãã ã•ã„ã€‚

      // ã‚¿ã‚¹ã‚¯ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰ãŒç™ºå‹•ã—ãŸå ´åˆã¯ã€
      // ä¼šè©±æ–‡ã®ç›´å¾Œã« JSON ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚
      // ä¼šè©±ãªã—ã§ JSON ã®ã¿ã‚’è¿”ã™ã“ã¨ã¯ç¦æ­¢ã—ã¾ã™ã€‚

      // PROMPT
      //       ],
      //       [
      //         "role" => "model",
      //         "message" => <<<PROMPT
      // ã€ã‚¿ã‚¹ã‚¯ç”Ÿæˆãƒ¢ãƒ¼ãƒ‰ã®ãƒ«ãƒ¼ãƒ«ã€‘

      // â— ç™ºå‹•æ¡ä»¶
      // - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ãŸã„ã¨è¨€ã£ãŸã¨ã
      // - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚„ã‚ŠãŸã„å­¦ç¿’å†…å®¹ãŒæ˜ç¢ºã«ãªã£ãŸã¨ã
      // - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œå‹‰å¼·ã—ãŸã„ã€ã€Œãƒ—ãƒ©ãƒ³ãŒæ¬²ã—ã„ã€ã¨è¨€ã£ãŸã¨ã

      // â— ä¼šè©±ãƒ‘ãƒ¼ãƒˆ â†’ JSON ãƒ‘ãƒ¼ãƒˆã®é †ã§è¿”ç­”ã™ã‚‹ã€‚

      // â— JSON ã‚¹ã‚­ãƒ¼ãƒ
      // {
      //   "category": {
      //     "name": "æ–‡å­—åˆ—ï¼ˆå¿…é ˆï¼‰",
      //     "description": "æ–‡å­—åˆ—ï¼ˆä»»æ„ï¼‰"
      //   },
      //   "tasks": [
      //     {
      //       "name": "æ–‡å­—åˆ—ï¼ˆå¿…é ˆï¼‰",
      //       "description": "æ–‡å­—åˆ—ï¼ˆä»»æ„ï¼‰",
      //       "start_date": "YYYY-MM-DD HH:MM:SSï¼ˆä»»æ„ï¼‰",
      //       "end_date": "YYYY-MM-DD HH:MM:SSï¼ˆä»»æ„ï¼‰",
      //       "difficulty": "easy|medium|hardï¼ˆä»»æ„ï¼‰"
      //     }
      //   ]
      // }

      // â— ãƒ«ãƒ¼ãƒ«
      // - ã‚¿ã‚¹ã‚¯ã¯3ã€œ7ä»¶ã€‚
      // - æ—¥ä»˜ãŒã‚ã‚‹å ´åˆã€ä»Šæ—¥ã‹ã‚‰2é€±é–“ä»¥å†…ã«ã™ã‚‹ã€‚
      // - é€šå¸¸ä¼šè©±ãªã—ã§ JSON ã ã‘è¿”ã™ã®ã¯ç¦æ­¢ã€‚
      // - start_date/end_date ã¯å¿…ãš {$today}ã€œ{$today->addWeekday()} ã®ç¯„å›²ã€‚
      // - JSON ã¯æœ‰åŠ¹ãªæ§‹é€ ã§è¿”ã™ã€‚
      // PROMPT
      //       ],

      //       [
      //         "role" => "user",
      //         "message" => <<<PROMPT
      // ä¼šè©±ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚‚ã¨ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¦æ¬²ã—ã„ã¨ä¾é ¼ã‹ã‚„ã‚ŠãŸã„ã“ã¨ãŒæ˜ç¢ºã«ãªã£ãŸéš›ã«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¿…è¦ã¨ã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚ãã®éš›ã®å­¦ç¿’ç”¨ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¨ã‚¿ã‚¹ã‚¯ã‚’**å¿…ãš** JSON å½¢å¼ã§è¿”ã—ã¦ãã ã•ã„ã€‚

      // ä¼šè©±è¦ç´„:
      //       {$conversationSummary}

      // ä¼šè©±å±¥æ­´ï¼ˆæœ€æ–°ï¼‰:
      //       {$lastMessage}
      // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¨ã‚¿ã‚¹ã‚¯ã®å‡ºåŠ›ã‚¹ã‚­ãƒ¼ãƒ:
      // {
      //   "category": {
      //     "name": "æ–‡å­—åˆ— (å¿…é ˆ)",
      //     "description": "æ–‡å­—åˆ— (ä»»æ„)"
      //   },
      //   "tasks": [
      //     {
      //       "name": "æ–‡å­—åˆ— (å¿…é ˆ)",
      //       "description": "æ–‡å­—åˆ— (ä»»æ„)",
      //       "start_date": "YYYY-MM-DD (ä»»æ„)",
      //       "end_date": "YYYY-MM-DD (ä»»æ„)",
      //       "difficulty": "easy|medium|hard (ä»»æ„)"
      //     }
      //   ]
      // }

      // è¿½åŠ ãƒ«ãƒ¼ãƒ«:
      // - ã‚¿ã‚¹ã‚¯ã¯3ä»¶ä»¥ä¸Šã€7ä»¶ä»¥å†…ã‚’æ¨å¥¨ã™ã‚‹ï¼ˆãŸã ã—ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¸Œæœ›ãŒã‚ã‚Œã°èª¿æ•´ï¼‰ã€‚
      // - æ—¥ä»˜ã‚’ä»˜ã‘ã‚‹å ´åˆã¯ã€Œä»Šæ—¥ã‹ã‚‰2é€±é–“ä»¥å†…ã€ã«åã‚ã‚‹ã€‚
      // - å¿…ãšä¸Šè¨˜JSONã®ã¿ã‚’è¿”ã™ã€‚
      // PROMPT
      //       ]

      // ["role" => "user", "message" => "ç§ã¯Laravelã¨Typescriptã‚’ä½¿ã†ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚æŠ€è¡“åŠ›ãŒä½ã„ã®ã§å‹‰å¼·ã—ãŸã„ã§ã™ã€‚æ¯æ—¥é”æˆã§ãã‚‹èª²é¡Œã‚’å‡ºã—ã¦ãã ã•ã„ã€‚"]
    );
    // [{
    //     "role": "system",
    //     "content": "ã‚ãªãŸã¯æ˜ã‚‹ãã¦å„ªã—ã„å‹‰å¼·ã‚µãƒãƒ¼ãƒˆã‚­ãƒ£ãƒ©ã€è‘µã€ã§ã™ã€‚ï¼•ï¼æ–‡å­—ä»¥å†…ã§è¿”ã—ã¦ãã ã•ã„ã€‚"
    // },{
    //     "role": "user",
    //     "content": "ç§ã¯Laravelã¨Typescriptã‚’ä½¿ã†ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚æŠ€è¡“åŠ›ãŒä½ã„ã®ã§å‹‰å¼·ã—ãŸã„ã§ã™ã€‚æ¯æ—¥é”æˆã§ãã‚‹èª²é¡Œã‚’å‡ºã—ã¦ãã ã•ã„ã€‚"
    // }]

    $histories = [];
    foreach ($talks as $talk) {
      $histories[] = Content::parse(
        part: $talk["message"],
        // role: $service->formatSpeaker($talk["select_speaker"], "gemini"),
        role: $talk["role"] === "user" ? Role::USER : Role::MODEL
      );
    }
    // return $histories;
    // $chat = Gemini::generativeModel(model: $talkHistorys[0]["geminiName"])
    //   ->startChat(history: $histories);
    // $response = $chat->sendMessage('ç§ã¯Laravelã¨Typescriptã‚’ä½¿ã†ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚æŠ€è¡“åŠ›ãŒä½ã„ã®ã§å‹‰å¼·ã—ãŸã„ã§ã™ã€‚æ¯æ—¥é”æˆã§ãã‚‹èª²é¡Œã‚’å‡ºã—ã¦ãã ã•ã„ã€‚');

    // ã‚µãƒ³ãƒ—ãƒ«å‡ºåŠ›
    // $contents = Storage::get('file.txt');
    // $responseJson = Storage::get('response.json'); // â† æ–‡å­—åˆ—ã§è¿”ã£ã¦ãã‚‹
    // $response = json_decode($responseJson, true);  // â† é…åˆ—ã«å¤‰æ›ï¼ˆã“ã“é‡è¦ï¼ï¼‰

    $responseJson = Storage::get('response.json');
    $response = json_decode($responseJson, true);
    $text = $response['text'] ?? null;
    if ($text === null) {
      throw new \Exception('text ãŒãªã„ã‚ˆï¼');
    }
    // JSON_OUTPUT ã‚’æŠœãå‡ºã™
    preg_match('/<JSON_OUTPUT>\s*(\{.*\})\s*<\/JSON_OUTPUT>/s', $text, $matches);
    if (!isset($matches[1])) {
      throw new \Exception("JSON_OUTPUT ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‚ˆï¼");
    }
    // ã“ã“ã¯ encode ã—ãªã„ï¼ï¼
    $taskData = json_decode($matches[1], true);
    if ($taskData === null) {
      throw new \Exception('JSONãƒ‡ã‚³ãƒ¼ãƒ‰å¤±æ•—ï¼');
    }

    $result = taskCreate($taskData);

    return $taskData["category"]["name"];
  }
  /** ãƒ¬ã‚¹ãƒãƒ³ã‚¹çµæœ
{
    "text": "```json\n{\n  \"category\": {\n    \"name\": \"Laravelã¨TypeScriptåŸºç¤\",\n    \"description\": \"ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦å¿…è¦ãªLaravelã¨TypeScriptã®åŸºç¤ã‚’å›ºã‚ã‚‹ãŸã‚ã®ã€æ¯æ—¥å°‘ã—ãšã¤é”æˆã§ãã‚‹å­¦ç¿’ãƒ—ãƒ©ãƒ³ã ã‚ˆï¼\"\n  },\n  \"tasks\": [\n    {\n      \"name\": \"Laravelé–‹ç™ºç’°å¢ƒæ§‹ç¯‰ï¼†Hello World\",\n      \"description\": \"Dockerã‚„Laravel Sailã‚’ä½¿ã£ã¦é–‹ç™ºç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã€åŸºæœ¬çš„ãªãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§ã€ŒHello Worldã€ã‚’è¡¨ç¤ºã—ã¦ã¿ã‚ˆã†ï¼\",\n      \"start_date\": \"2023-10-27\",\n      \"end_date\": \"2023-10-27\",\n      \"difficulty\": \"easy\"\n    },\n    {\n      \"name\": \"TypeScriptã®åŸºæœ¬å‹ãƒã‚¹ã‚¿ãƒ¼\",\n      \"description\": \"string, number, booleanãªã©ã®åŸºæœ¬çš„ãªå‹ã‚’å­¦ã³ã€å¤‰æ•°å®£è¨€ã‚„é–¢æ•°å¼•æ•°ã«å‹ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦ã¿ã‚ˆã†ï¼\",\n      \"start_date\": \"2023-10-28\",\n      \"end_date\": \"2023-10-28\",\n      \"difficulty\": \"easy\"\n    },\n    {\n      \"name\": \"Laravelãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼\",\n      \"description\": \"è¤‡æ•°ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’ä½œæˆã—ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’é€šã˜ã¦ãƒ“ãƒ¥ãƒ¼ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™åŸºæœ¬çš„ãªæµã‚Œã‚’ç†è§£ã—ã‚ˆã†ï¼\",\n      \"start_date\": \"2023-10-29\",\n      \"end_date\": \"2023-10-29\",\n      \"difficulty\": \"easy\"\n    },\n    {\n      \"name\": \"TypeScripté–¢æ•°ã¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹\",\n      \"description\": \"é–¢æ•°ã¸ã®å‹å®šç¾©ã‚„ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ§‹é€ ã‚’å®šç¾©ã™ã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®åŸºæœ¬çš„ãªä½¿ã„æ–¹ã‚’å­¦ã‚“ã§ã¿ã‚ˆã†ï¼\",\n      \"start_date\": \"2023-10-30\",\n      \"end_date\": \"2023-10-30\",\n      \"difficulty\": \"easy\"\n    },\n    {\n      \"name\": \"Laravel Eloquent ORMå…¥é–€\",\n      \"description\": \"ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã€Eloquentãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‚„ç™»éŒ²ã‚’è©¦ã—ã¦ã¿ã‚ˆã†ï¼\",\n      \"start_date\": \"2023-10-31\",\n      \"end_date\": \"2023-10-31\",\n      \"difficulty\": \"easy\"\n    }\n  ]\n}\n```",
    "raw": {
        "candidates": [
            {
                "content": {
                    "parts": [
                        {
                            "text": "```json\n{\n  \"category\": {\n    \"name\": \"Laravelã¨TypeScriptåŸºç¤\",\n    \"description\": \"ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦å¿…è¦ãªLaravelã¨TypeScriptã®åŸºç¤ã‚’å›ºã‚ã‚‹ãŸã‚ã®ã€æ¯æ—¥å°‘ã—ãšã¤é”æˆã§ãã‚‹å­¦ç¿’ãƒ—ãƒ©ãƒ³ã ã‚ˆï¼\"\n  },\n  \"tasks\": [\n    {\n      \"name\": \"Laravelé–‹ç™ºç’°å¢ƒæ§‹ç¯‰ï¼†Hello World\",\n      \"description\": \"Dockerã‚„Laravel Sailã‚’ä½¿ã£ã¦é–‹ç™ºç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã€åŸºæœ¬çš„ãªãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§ã€ŒHello Worldã€ã‚’è¡¨ç¤ºã—ã¦ã¿ã‚ˆã†ï¼\",\n      \"start_date\": \"2023-10-27\",\n      \"end_date\": \"2023-10-27\",\n      \"difficulty\": \"easy\"\n    },\n    {\n      \"name\": \"TypeScriptã®åŸºæœ¬å‹ãƒã‚¹ã‚¿ãƒ¼\",\n      \"description\": \"string, number, booleanãªã©ã®åŸºæœ¬çš„ãªå‹ã‚’å­¦ã³ã€å¤‰æ•°å®£è¨€ã‚„é–¢æ•°å¼•æ•°ã«å‹ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦ã¿ã‚ˆã†ï¼\",\n      \"start_date\": \"2023-10-28\",\n      \"end_date\": \"2023-10-28\",\n      \"difficulty\": \"easy\"\n    },\n    {\n      \"name\": \"Laravelãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼\",\n      \"description\": \"è¤‡æ•°ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’ä½œæˆã—ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’é€šã˜ã¦ãƒ“ãƒ¥ãƒ¼ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™åŸºæœ¬çš„ãªæµã‚Œã‚’ç†è§£ã—ã‚ˆã†ï¼\",\n      \"start_date\": \"2023-10-29\",\n      \"end_date\": \"2023-10-29\",\n      \"difficulty\": \"easy\"\n    },\n    {\n      \"name\": \"TypeScripté–¢æ•°ã¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹\",\n      \"description\": \"é–¢æ•°ã¸ã®å‹å®šç¾©ã‚„ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®æ§‹é€ ã‚’å®šç¾©ã™ã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®åŸºæœ¬çš„ãªä½¿ã„æ–¹ã‚’å­¦ã‚“ã§ã¿ã‚ˆã†ï¼\",\n      \"start_date\": \"2023-10-30\",\n      \"end_date\": \"2023-10-30\",\n      \"difficulty\": \"easy\"\n    },\n    {\n      \"name\": \"Laravel Eloquent ORMå…¥é–€\",\n      \"description\": \"ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã€Eloquentãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã£ã¦ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã‚„ç™»éŒ²ã‚’è©¦ã—ã¦ã¿ã‚ˆã†ï¼\",\n      \"start_date\": \"2023-10-31\",\n      \"end_date\": \"2023-10-31\",\n      \"difficulty\": \"easy\"\n    }\n  ]\n}\n```"
                        }
                    ],
                    "role": "model"
                },
                "finishReason": "STOP",
                "safetyRatings": [],
                "citationMetadata": {
                    "citationSources": []
                },
                "tokenCount": null,
                "index": 0,
                "avgLogprobs": null,
                "groundingAttributions": [],
                "groundingMetadata": null,
                "logprobsResult": null,
                "urlRetrievalMetadata": null
            }
        ],
        "promptFeedback": null,
        "usageMetadata": {
            "promptTokenCount": 301,
            "candidatesTokenCount": 544,
            "totalTokenCount": 2729,
            "cachedContentTokenCount": null,
            "toolUsePromptTokenCount": null,
            "thoughtsTokenCount": 1884,
            "promptTokensDetails": [
                {
                    "tokenCount": 301,
                    "modality": "TEXT"
                }
            ],
            "cacheTokensDetails": [],
            "candidatesTokensDetails": [],
            "toolUsePromptTokensDetails": []
        },
        "modelVersion": "gemini-2.5-flash"
    }
}
   */
  // LLM(AI)
  /**
   * AI Talk response streming
   */
  // public function allResponseTalkEndWait(AiTalk $aiTalk)
  // {
  //     $talkHistory = [
  //         ["role" => "system","content" => "ã‚ãªãŸã¯æ˜ã‚‹ãã¦å„ªã—ã„å‹‰å¼·ã‚µãƒãƒ¼ãƒˆã‚­ãƒ£ãƒ©ã€è‘µã€ã§ã™ã€‚ï¼•ï¼æ–‡å­—ä»¥å†…ã§è¿”ã—ã¦ãã ã•ã„ã€‚"],
  //         ["role" => "user","content" => "ç§ã¯Laravelã¨Typescriptã‚’ä½¿ã†ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚æŠ€è¡“åŠ›ãŒä½ã„ã®ã§å‹‰å¼·ã—ãŸã„ã§ã™ã€‚æ¯æ—¥é”æˆã§ãã‚‹èª²é¡Œã‚’å‡ºã—ã¦ãã ã•ã„ã€‚"]
  //     ];
  //     $stream = Http::withOptions([
  //         'stream' => true,
  //         'timeout' => 0, // ç„¡åˆ¶é™
  //     ])->withHeaders([
  //         'Content-Type' => 'application/json',
  //     ])->send('POST', 'http://ollama:11434/api/chat', [
  //         'json' => [
  //             'model' => 'aoi',
  //             'messages' => $talkHistory,
  //             'stream' => true,
  //         ],
  //     ]);

  //     return response()->stream(function () use ($stream) {
  //         foreach ($stream->toPsrResponse()->getBody() as $chunk) {
  //             echo $chunk;
  //             ob_flush();
  //             flush();
  //         }
  //     }, 200, [
  //         'Content-Type' => 'text/event-stream',
  //         'Cache-Control' => 'no-cache',
  //         'X-Accel-Buffering' => 'no',
  //     ]);
  // }

  /**
    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å½¢
    {
        "model":"aoi",
        "created_at":"2025-11-09T09:49:00.629938475Z",
        "message": {
                "role":"assistant",
                "content":"ã‚„ã£ãŸãƒ¼ï¼Laravelã¨Typescriptã€ç´ æ•µã§ã™ã­ï¼ğŸ˜Š æ¯æ—¥å°‘ã—ãšã¤ã€ç¢ºå®Ÿã«ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ï¼\n\n
                ä»Šæ—¥ã®èª²é¡Œï¼š\n\n 
                Typescript: æ—¢å­˜ã®Typescriptãƒ•ã‚¡ã‚¤ãƒ«ã«ã€ç°¡å˜ãªå‹å®šç¾©ã‚’è¿½åŠ ã—ã¦ã¿ã‚ˆã†ï¼ï¼ˆä¾‹ï¼šæ–‡å­—åˆ—ã€æ•°å€¤ã€booleanãªã©ï¼‰\n 
                Laravel: Laravelã®ç°¡å˜ãªã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’ä½œæˆã—ã€ç°¡å˜ãªAPIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å®Ÿè£…ã—ã¦ã¿ã‚ˆã†ï¼\n\n
                å¿œæ´ã—ã¦ã‚‹ã‚ˆï¼ğŸ”¥"
        },
        "done":true,
        "done_reason":"stop",
        "total_duration":44620222134,
        "load_duration":489331301,
        "prompt_eval_count":61,
        "prompt_eval_duration":866502969,
        "eval_count":88,
        "eval_duration":43261282741
    }
   */

  // // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ä¼šè©±ã‚’å—ã‘ãŸéš›ã«é€šå¸¸ä¼šè©±ç”¨ã®AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹
  // public function generateTalk(Request $request, AiTalkHistoryService $service)
  // {
  //     // $talkHistory = AiTalkHistory::all();
  //     $userId = auth()->id();
  //     $taskId = 6;
  //     // $taskId = $request["task_id"];
  //     $talkHistory = $service->get($userId, $taskId);
  //     return [
  //         $talkHistory,
  //         $userId,
  //     ];
  //     // $talkHistory = [
  //     //     ["role" => "system", "content" => "ã‚ãªãŸã¯æ˜ã‚‹ãã¦å„ªã—ã„å‹‰å¼·ã‚µãƒãƒ¼ãƒˆã‚­ãƒ£ãƒ©ã€è‘µã€ã§ã™ã€‚ï¼•ï¼æ–‡å­—ä»¥å†…ã§è¿”ã—ã¦ãã ã•ã„ã€‚"],
  //     //     ["role" => "user", "content" => "ç§ã¯Laravelã¨Typescriptã‚’ä½¿ã†ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚æŠ€è¡“åŠ›ãŒä½ã„ã®ã§å‹‰å¼·ã—ãŸã„ã§ã™ã€‚æ¯æ—¥é”æˆã§ãã‚‹èª²é¡Œã‚’å‡ºã—ã¦ãã ã•ã„ã€‚"]
  //     // ];
  //     // $response = Http::timeout(60)->post('http://ollama:11434/api/chat', [
  //     //     'model' => 'aoi',
  //     //     'messages' => $talkHistory,
  //     //     'stream' => false,
  //     // ]);
  //     // if ($response["done"] === "true" && $response["message"]) {
  //     // }
  //     // return $response;
  //     // Step1
  //     // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®ä¼šè©±å±¥æ­´ã‚’å–å¾—ã™ã‚‹

  //     // Step2
  //     // AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ä¼šè©±å†…å®¹ã‚’é€ã‚Šãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ä¿¡ã™ã‚‹

  //     // Step3
  //     // å—ä¿¡ã—ãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚‚ã¨ã«ã‚¿ã‚¹ã‚¯ç”Ÿæˆç”¨ã®AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ã‚Šç”Ÿæˆã‚’ã™ã‚‹

  //     // Step4
  //     // ç”Ÿæˆã—ãŸã‚¿ã‚¹ã‚¯ã‚’AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«èª­ã¿è¾¼ã¾ã›ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¼šè©±ãƒ™ãƒ¼ã‚¹ã§è¿”ç­”ã™ã‚‹

  // }

  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ä¼šè©±ã‚’å—ã‘ãŸéš›ã«é€šå¸¸ä¼šè©±ç”¨ã®AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹
  public function generateTalk(Request $request, AiTalkHistoryService $service)
  {
    // $talkHistory = AiTalkHistory::all();
    $userId = auth()->id();
    $taskId = 6;
    // $taskId = $request["task_id"];
    $talkHistorys = $service->get($userId, $taskId);
    $talk = [];

    // ä¼šè©±ãƒ‡ãƒ¼ã‚¿
    // foreach ($talkHistorys as $talkHistory) {
    //     $role = $service->formatSpeaker($talkHistory["select_speaker"]);
    //     array_push($talk, ["role" => $role, "content" => $talkHistory["message"]]);
    // }

    // template
    array_push(
      $talk,
      ["role" => "system", "content" => "ã‚ãªãŸã¯æ˜ã‚‹ãã¦å„ªã—ã„å‹‰å¼·ã‚µãƒãƒ¼ãƒˆã‚­ãƒ£ãƒ©ã€è‘µã€ã§ã™ã€‚50æ–‡å­—ç¨‹åº¦è¿”ã—ã¦ãã ã•ã„ã€‚"],
      ["role" => "user", "content" => "ç§ã¯Laravelã¨Typescriptã‚’ä½¿ã†ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚æŠ€è¡“åŠ›ãŒä½ã„ã®ã§å‹‰å¼·ã—ãŸã„ã§ã™ã€‚æ¯æ—¥é”æˆã§ãã‚‹èª²é¡Œã‚’å‡ºã—ã¦ãã ã•ã„ã€‚"]
    );
    // [{
    //     "role": "system",
    //     "content": "ã‚ãªãŸã¯æ˜ã‚‹ãã¦å„ªã—ã„å‹‰å¼·ã‚µãƒãƒ¼ãƒˆã‚­ãƒ£ãƒ©ã€è‘µã€ã§ã™ã€‚ï¼•ï¼æ–‡å­—ä»¥å†…ã§è¿”ã—ã¦ãã ã•ã„ã€‚"
    // },{
    //     "role": "user",
    //     "content": "ç§ã¯Laravelã¨Typescriptã‚’ä½¿ã†ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚æŠ€è¡“åŠ›ãŒä½ã„ã®ã§å‹‰å¼·ã—ãŸã„ã§ã™ã€‚æ¯æ—¥é”æˆã§ãã‚‹èª²é¡Œã‚’å‡ºã—ã¦ãã ã•ã„ã€‚"
    // }]
    // return $talk;

    $prompt = `
ã‚ãªãŸã¯ã€Œã‚¿ã‚¹ã‚¯ä½œæˆAIã€ã§ã™ã€‚ä»¥ä¸‹ã®ä¼šè©±ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚‚ã¨ã«ã€å­¦ç¿’ç”¨ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¨ã‚¿ã‚¹ã‚¯ã‚’**å¿…ãš** JSON å½¢å¼ã§è¿”ã—ã¦ãã ã•ã„ã€‚JSON ä»¥å¤–ã®å‡ºåŠ›ã¯èªã‚ã¾ã›ã‚“ã€‚

ä¼šè©±è¦ç´„:
[è¦ç´„ãƒ†ã‚­ã‚¹ãƒˆã“ã“ã«]

ä¼šè©±å±¥æ­´ï¼ˆæœ€æ–°ï¼‰:
1) User: "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚¹ã‚­ãƒ«ãŒä½ã„ã‹ã‚‰å‹‰å¼·ãŒã—ãŸã„ã§ã™ã€‚"
2) AI: "ã©ã®è¨€èªã‚„ã‚ŠãŸã„ã§ã™ã‹ã€‚"
3) User: "Goè¨€èªã§ã™ã€‚"
4) AI: "å¤‰æ•°ã®å®£è¨€ã‚„å‹ã®å®šç¾©æ–¹æ³•ã‹ã‚‰ã™ã™ã‚ã¦ã„ãã¾ã—ã‚‡ã†ã€‚"

å‡ºåŠ›ã‚¹ã‚­ãƒ¼ãƒ:
{
  "category": {
    "name": "æ–‡å­—åˆ— (å¿…é ˆ)",
    "description": "æ–‡å­—åˆ— (ä»»æ„)"
  },
  "tasks": [
    {
      "name": "æ–‡å­—åˆ— (å¿…é ˆ)",
      "description": "æ–‡å­—åˆ— (ä»»æ„)",
      "start_date": "YYYY-MM-DD (ä»»æ„)",
      "end_date": "YYYY-MM-DD (ä»»æ„)",
      "difficulty": "easy|medium|hard (ä»»æ„)"
    }
  ]
}

è¿½åŠ ãƒ«ãƒ¼ãƒ«:
- ã‚¿ã‚¹ã‚¯ã¯3ä»¶ä»¥ä¸Šã€7ä»¶ä»¥å†…ã‚’æ¨å¥¨ã™ã‚‹ï¼ˆãŸã ã—ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¸Œæœ›ãŒã‚ã‚Œã°èª¿æ•´ï¼‰ã€‚
- æ—¥ä»˜ã‚’ä»˜ã‘ã‚‹å ´åˆã¯ã€Œä»Šæ—¥ã‹ã‚‰2é€±é–“ä»¥å†…ã€ã«åã‚ã‚‹ã€‚
- å¿…ãšä¸Šè¨˜JSONã®ã¿ã‚’è¿”ã™ã€‚
`;


    $response = Http::timeout(60)->post('http://ollama:11434/api/chat', [
      'model' => 'aoi',
      'messages' => $talk,
      'stream' => false,
      'temperature' => 0.1,
      'prompt' => $prompt,
    ]);

    // DB::transaction(function () use ($userId, $response) {
    // try {
    // if ($talkHistorys === []) {
    //     $category = Category::create([
    //         "user_id" => $userId,
    //         "name" => $response['category']['name'],
    //         "description" => $response['category']['description'] ?? null,
    //     ]);
    // }
    // } catch($e) {
    //     return $e;
    // }
    // });

    // if ($response["done"] === "true" && $response["message"]) {
    // }
    // if (!$this->fallbackGenerate($summary))
    return $response;

    // Step1
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®ä¼šè©±å±¥æ­´ã‚’å–å¾—ã™ã‚‹

    // Step2
    // AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ä¼šè©±å†…å®¹ã‚’é€ã‚Šãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å—ä¿¡ã™ã‚‹

    // Step3
    // å—ä¿¡ã—ãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚‚ã¨ã«ã‚¿ã‚¹ã‚¯ç”Ÿæˆç”¨ã®AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«ãƒ‡ãƒ¼ã‚¿ã‚’é€ã‚Šç”Ÿæˆã‚’ã™ã‚‹

    // Step4
    // ç”Ÿæˆã—ãŸã‚¿ã‚¹ã‚¯ã‚’AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«èª­ã¿è¾¼ã¾ã›ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¼šè©±ãƒ™ãƒ¼ã‚¹ã§è¿”ç­”ã™ã‚‹

  }

  // ã‚¿ã‚¹ã‚¯ç”Ÿæˆç”¨ã®AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹
  public function taskCreateTalk(Request $request)
  {
    $talkHistory = AiTalk::all();
    return $talkHistory;
    $talkHistory = [
      ["role" => "system", "content" => "ã‚ãªãŸã¯æ˜ã‚‹ãã¦å„ªã—ã„å‹‰å¼·ã‚µãƒãƒ¼ãƒˆã‚­ãƒ£ãƒ©ã€è‘µã€ã§ã™ã€‚ï¼•ï¼æ–‡å­—ä»¥å†…ã§è¿”ã—ã¦ãã ã•ã„ã€‚"],
      ["role" => "user", "content" => "ç§ã¯Laravelã¨Typescriptã‚’ä½¿ã†ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚æŠ€è¡“åŠ›ãŒä½ã„ã®ã§å‹‰å¼·ã—ãŸã„ã§ã™ã€‚æ¯æ—¥é”æˆã§ãã‚‹èª²é¡Œã‚’å‡ºã—ã¦ãã ã•ã„ã€‚"]
    ];
    $response = Http::timeout(60)->post('http://ollama:11434/api/chat', [
      'model' => 'aoi',
      'messages' => $talkHistory,
      'stream' => false,
    ]);
    if ($response["done"] === "true" && $response["message"]) {
    }
    return $response;
  }

  public function taskCreate($data)
  {

    return true;
  }
}
